name: GHCR Cleanup

"on":
  # Weekly on Wednesday at 03:41 UTC
  schedule:
    - cron: "41 3 * * 3"
  workflow_dispatch:
    inputs:
      RETENTION_DAYS:
        description: "Retention window in days for cleanup"
        type: number
        default: 30
      RELEASE_TAG_KEEP_COUNT:
        description: "How many latest release tags to keep"
        type: number
        default: 3
      dry_run:
        description: "Run in dry-run mode (recommended first)"
        type: boolean
        default: true
      log_level:
        description: "Action log level"
        type: choice
        options:
          - info
          - debug
          - warn
          - error
        default: info

env:
  # Repo-specific high-level knobs
  PACKAGE_NAME: aicage-image-util
  RETENTION_DAYS: ${{ github.event_name == 'workflow_dispatch' && inputs.RETENTION_DAYS || 30 }}
  RELEASE_TAG_KEEP_COUNT: ${{ github.event_name == 'workflow_dispatch' && inputs.RELEASE_TAG_KEEP_COUNT || 3 }}

permissions:
  contents: read
  packages: write

jobs:
  prepare-retention-regex:
    name: Prepare retention regex
    runs-on: ubuntu-latest
    outputs:
      package_name: ${{ steps.config.outputs.package_name }}
      retention_days: ${{ steps.config.outputs.retention_days }}
      keep_tags_regex: ${{ steps.regex.outputs.keep_tags_regex }}
      release_list: ${{ steps.regex.outputs.release_list }}
    steps:
      - name: Export config
        id: config
        shell: bash
        run: |
          set -euo pipefail
          {
            echo "package_name=${PACKAGE_NAME}"
            echo "retention_days=${RETENTION_DAYS}"
          } >> "${GITHUB_OUTPUT}"

      - name: Checkout
        uses: actions/checkout@v6.0.1
        with:
          fetch-depth: 0

      - name: Build release list and keep-regex
        id: regex
        shell: bash
        run: |
          set -euo pipefail

          N="${RELEASE_TAG_KEEP_COUNT}"
          if ! [[ "${N}" =~ ^[0-9]+$ ]]; then
            echo "RELEASE_TAG_KEEP_COUNT must be an integer, got: ${N}" >&2
            exit 1
          fi

          git fetch --tags --force

          # Repo-specific release source:
          # last N tags by semantic version ordering.
          mapfile -t TAGS < <(git tag -l --sort=-version:refname | head -n "${N}")

          if (( ${#TAGS[@]} == 0 )); then
            echo "No release tags found. RELEASE_LIST must be non-empty." >&2
            exit 1
          fi

          ESCAPED_TAGS=()
          for tag in "${TAGS[@]}"; do
            # Escape regex metacharacters in tag names.
            escaped="$(printf '%s' "${tag}" | sed -E 's/[][(){}.^$*+?|\\-]/\\\\&/g')"
            ESCAPED_TAGS+=("${escaped}")
          done
          RELEASE_LIST="$(IFS='|'; echo "${ESCAPED_TAGS[*]}")"

          ARCH_SUFFIX='(-amd64|-arm64)?'
          KEEP_TAGS_REGEX="^(agent-version|${RELEASE_LIST})${ARCH_SUFFIX}$"

          {
            echo "release_list=${RELEASE_LIST}"
            echo "keep_tags_regex=${KEEP_TAGS_REGEX}"
          } | tee /dev/stderr >> "${GITHUB_OUTPUT}"

  ghcr-cleanup:
    name: GHCR cleanup
    needs: prepare-retention-regex
    uses: aicage/github-actions/.github/workflows/ghcr-cleanup.yml@0.2.1
    with:
      owner: ${{ github.repository_owner }}
      repository: ${{ github.event.repository.name }}
      package: ${{ needs.prepare-retention-regex.outputs.package_name }}
      older_than_days: ${{ fromJSON(needs.prepare-retention-regex.outputs.retention_days) }}
      keep_tags_regex: ${{ needs.prepare-retention-regex.outputs.keep_tags_regex }}
      dry_run: ${{ github.event_name == 'workflow_dispatch' && inputs.dry_run || false }}
      log_level: ${{ github.event_name == 'workflow_dispatch' && inputs.log_level || 'info' }}
    secrets: inherit
