name: Build Image Util
run-name: Build image util (${{ github.ref_name }})

"on":
  schedule:
    - cron: "0 2 * * 2"
  push:
    tags:
      - "*"
  workflow_dispatch: {}

concurrency:
  group: build-image-util-${{ github.run_id }}
  cancel-in-progress: false

permissions:
  contents: read
  packages: write
  id-token: write
  actions: read

jobs:
  resolve-ref:
    runs-on: ubuntu-latest
    outputs:
      GIT_REF: ${{ steps.ref.outputs.GIT_REF }}
      UNIQUE: ${{ steps.ref.outputs.UNIQUE }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.1
      - name: Resolve git ref
        id: ref
        run: |
          set -euo pipefail
          if [[ "${GITHUB_EVENT_NAME}" == "schedule" ]]; then
            git fetch --tags
            GIT_REF="$(git tag --list --sort=version:refname | tail -n 1)"
            if [[ -z "${GIT_REF}" ]]; then
              echo "Git tag is empty for latest release" >&2
              exit 1
            fi
          else
            GIT_REF="${GITHUB_REF_NAME}"
          fi
          {
            echo "GIT_REF=${GIT_REF}"
            echo "UNIQUE=${GITHUB_SHA::7}-$(uuidgen)"
          } | tee /dev/stderr >> "$GITHUB_OUTPUT"

  lint:
    name: Lint for ${{ needs.resolve-ref.outputs.GIT_REF }}
    runs-on: ubuntu-latest
    needs: resolve-ref
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.resolve-ref.outputs.GIT_REF }}

      - name: "Test: Set up Python"
        uses: actions/setup-python@v6.1.0
        with:
          python-version: "3.x"

      - name: "Test: Remove Python yq and keep using Go yq"
        run: |
          python -m pip uninstall -y yq

      - name: "Test: Install lint deps"
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt

      - name: "Test: Run linters (yamllint, ruff, pymarkdown)"
        run: |
          yamllint .
          ruff check .
          pymarkdown --config .pymarkdown.json scan --recurse --exclude './.venv/' .

  build:
    name: "${{ matrix.arch }}: Build, sign, and publish image util"
    runs-on: ${{ matrix.runner }}
    needs: [resolve-ref, lint]
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: amd64
            platform: linux/amd64
            runner: ubuntu-latest
          - arch: arm64
            platform: linux/arm64
            runner: ubuntu-24.04-arm
    env:
      PLATFORM: ${{ matrix.platform }}
      ARCH_SUFFIX: ${{ matrix.arch }}
      AICAGE_VERSION: ${{ needs.resolve-ref.outputs.GIT_REF }}
      IMAGE_NAME: ghcr.io/aicage/aicage-image-util
      IMAGE_TEST_TAG: ${{ needs.resolve-ref.outputs.UNIQUE }}-${{ matrix.arch }}-test
    outputs:
      INDEX_DIGEST_amd64: ${{ steps.out-amd64.outputs.INDEX_DIGEST }}
      INDEX_DIGEST_arm64: ${{ steps.out-arm64.outputs.INDEX_DIGEST }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.1
        with:
          ref: ${{ needs.resolve-ref.outputs.GIT_REF }}

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3.11.1
        with:
          driver: docker-container

      - name: Log in to Docker Hub
        uses: docker/login-action@v3.6.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build test image tag
        id: build_image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile
          push: true
          provenance: true
          platforms: ${{ env.PLATFORM }}
          tags: |
            ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TEST_TAG }}
          labels: |
            org.opencontainers.image.description=Utility image for aicage runtime tasks

      - name: Export digest (amd64)
        id: out-amd64
        if: matrix.arch == 'amd64'
        run: |
          set -euo pipefail
          (
            echo "INDEX_DIGEST=${{ steps.build_image.outputs.digest }}"
          ) | tee /dev/stderr >> "$GITHUB_OUTPUT"

      - name: Export digest (arm64)
        id: out-arm64
        if: matrix.arch == 'arm64'
        run: |
          set -euo pipefail
          (
            echo "INDEX_DIGEST=${{ steps.build_image.outputs.digest }}"
          ) | tee /dev/stderr >> "$GITHUB_OUTPUT"

  multiarch:
    name: Run multi-arch sign/provenance/publish
    needs: [resolve-ref, build]
    uses: aicage/github-actions/.github/workflows/multiarch-image-build-sign-provenance.yml@main
    with:
      image_ref: ghcr.io/aicage/aicage-image-util
      version_tag: ${{ needs.resolve-ref.outputs.GIT_REF }}
      purpose_tag: agent-version
      index_digest_amd64: ${{ needs.build.outputs.INDEX_DIGEST_amd64 }}
      index_digest_arm64: ${{ needs.build.outputs.INDEX_DIGEST_arm64 }}
      actions_ref: main
    secrets: inherit
